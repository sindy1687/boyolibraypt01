<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>身分審核系統測試</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
        .user-info { background: #f0f8ff; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .application-item { background: #fff3cd; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #ffc107; }
        .application-item.pending { border-left-color: #f56565; }
        .application-item.approved { border-left-color: #28a745; }
        .application-item.rejected { border-left-color: #6c757d; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .result { margin: 10px 0; padding: 10px; background: #e7f3ff; border-radius: 4px; }
        .form-group { margin: 10px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-sizing: border-box;
        }
        .form-group textarea { resize: vertical; }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin: 2px;
        }
        .status-badge.pending { background: #fed7d7; color: #742a2a; }
        .status-badge.approved { background: #c6f6d5; color: #22543d; }
        .status-badge.rejected { background: #e2e8f0; color: #4a5568; }
    </style>
</head>
<body>
    <h1>身分審核系統測試</h1>
    
    <div class="test-section">
        <h2>模擬登入系統</h2>
        <div class="form-group">
            <label>使用者名稱：</label>
            <input type="text" id="test-username" placeholder="輸入使用者名稱">
        </div>
        <div class="form-group">
            <label>真實姓名：</label>
            <input type="text" id="test-realname" placeholder="輸入真實姓名">
        </div>
        <div class="form-group">
            <label>電話號碼：</label>
            <input type="tel" id="test-phone" placeholder="0912345678">
        </div>
        <div class="form-group">
            <label>角色：</label>
            <select id="test-role">
                <option value="student">學生</option>
                <option value="staff">老師/館員</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="testLogin()">模擬登入</button>
        <button class="btn btn-info" onclick="testAdminLogin()">管理員登入</button>
        <button class="btn btn-warning" onclick="testLogout()">登出</button>
    </div>

    <div class="test-section">
        <h2>創建申請記錄</h2>
        <button class="btn btn-warning" onclick="createApplications()">創建範例申請</button>
        <button class="btn btn-info" onclick="showApplications()">顯示所有申請</button>
        <button class="btn btn-success" onclick="showPendingApplications()">顯示待審核申請</button>
    </div>

    <div class="test-section">
        <h2>身分審核管理</h2>
        <button class="btn btn-primary" onclick="testApprovalManagement()">測試審核管理</button>
        <button class="btn btn-success" onclick="testApproveApplication()">測試通過申請</button>
        <button class="btn btn-danger" onclick="testRejectApplication()">測試拒絕申請</button>
        <button class="btn btn-info" onclick="testSearchApplications()">測試搜尋申請</button>
    </div>

    <div class="test-section">
        <h2>Google Sheets 同步</h2>
        <button class="btn btn-success" onclick="testGoogleSync()">測試同步到 Google Sheets</button>
    </div>

    <div class="test-section">
        <h2>測試結果</h2>
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h2>當前狀態</h2>
        <div id="current-status"></div>
    </div>

    <script>
        // 模擬圖書館系統
        class TestLibrary {
            constructor() {
                this.borrowedBooks = [];
                this.users = [];
                this.currentUser = null;
                this.adminUsername = 'sindy16872000';
                this.settings = {
                    notifications: [],
                    staffApplications: [],
                    googleWebAppUrl: 'https://script.google.com/macros/s/test/exec'
                };
            }

            // 檢查是否為管理員
            isAdminUser() {
                return this.currentUser && this.currentUser.username === this.adminUsername;
            }

            // 模擬登入
            login(username, realName, phoneNumber, role) {
                if (!username || !realName || !phoneNumber) {
                    return { success: false, message: '請填寫完整資訊' };
                }

                if (!/^[0-9]{10}$/.test(phoneNumber)) {
                    return { success: false, message: '電話號碼必須是10位數字' };
                }

                // 檢查是否為管理員
                const isAdmin = username === this.adminUsername;
                
                // 處理老師/館員身份申請
                let finalRole = role;
                if (role === 'staff' && !isAdmin) {
                    // 檢查是否已經有申請記錄
                    const existingApplication = this.settings.staffApplications.find(
                        app => app.username === username && app.status === 'approved'
                    );
                    
                    const pendingApplication = this.settings.staffApplications.find(
                        app => app.username === username && app.status === 'pending'
                    );

                    if (!existingApplication && !pendingApplication) {
                        // 創建新的申請記錄
                        const application = {
                            id: Date.now().toString(),
                            username,
                            realName,
                            phoneNumber,
                            requestedRole: 'staff',
                            status: 'pending',
                            submittedAt: new Date().toISOString(),
                            reviewedAt: null,
                            reviewedBy: null,
                            decision: null,
                            reason: null,
                            note: null
                        };

                        this.settings.staffApplications.push(application);

                        // 申請人暫時以學生身份使用
                        finalRole = 'student';
                        
                        return { 
                            success: true, 
                            message: '老師/館員身份申請已提交，審核通過前將以學生身份使用系統',
                            user: { username, realName, phoneNumber, role: finalRole },
                            applicationCreated: true
                        };
                    } else if (pendingApplication) {
                        // 有待審核的申請，以學生身份使用
                        finalRole = 'student';
                        return { 
                            success: true, 
                            message: '您的老師/館員身份申請正在審核中，請耐心等候',
                            user: { username, realName, phoneNumber, role: finalRole },
                            applicationPending: true
                        };
                    } else if (existingApplication) {
                        // 已通過審核，可以使用老師身份
                        finalRole = 'staff';
                        return { 
                            success: true, 
                            message: '老師/館員身份已驗證，歡迎使用！',
                            user: { username, realName, phoneNumber, role: finalRole },
                            applicationApproved: true
                        };
                    }
                }

                return { 
                    success: true, 
                    message: `歡迎 ${realName}！`,
                    user: { username, realName, phoneNumber, role: finalRole }
                };
            }

            // 登出
            logout() {
                const username = this.currentUser ? this.currentUser.username : '';
                this.currentUser = null;
                return { success: true, message: `${username} 已登出` };
            }

            // 創建範例申請
            createSampleApplications() {
                const applications = [
                    {
                        id: '1',
                        username: 'teacher1',
                        realName: '張老師',
                        phoneNumber: '0912345678',
                        requestedRole: 'staff',
                        status: 'pending',
                        submittedAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                        reviewedAt: null,
                        reviewedBy: null,
                        decision: null,
                        reason: null,
                        note: null
                    },
                    {
                        id: '2',
                        username: 'teacher2',
                        realName: '李老師',
                        phoneNumber: '0987654321',
                        requestedRole: 'staff',
                        status: 'pending',
                        submittedAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                        reviewedAt: null,
                        reviewedBy: null,
                        decision: null,
                        reason: null,
                        note: null
                    },
                    {
                        id: '3',
                        username: 'teacher3',
                        realName: '王老師',
                        phoneNumber: '0923456789',
                        requestedRole: 'staff',
                        status: 'approved',
                        submittedAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                        reviewedAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                        reviewedBy: 'sindy16872000',
                        decision: 'approved',
                        reason: '審核通過',
                        note: '資料完整，身份確認'
                    },
                    {
                        id: '4',
                        username: 'teacher4',
                        realName: '陳老師',
                        phoneNumber: '0934567890',
                        requestedRole: 'staff',
                        status: 'rejected',
                        submittedAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                        reviewedAt: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000).toISOString(),
                        reviewedBy: 'sindy16872000',
                        decision: 'rejected',
                        reason: '審核拒絕',
                        note: '資料不符，需要重新申請'
                    }
                ];

                // 添加到系統
                applications.forEach(app => {
                    const existingIndex = this.settings.staffApplications.findIndex(a => a.id === app.id);
                    if (existingIndex === -1) {
                        this.settings.staffApplications.push(app);
                    }
                });

                return '已創建 4 筆範例申請記錄';
            }

            // 獲取申請列表
            getApplications(filterType = 'all') {
                let applications = this.settings.staffApplications;

                if (filterType === 'pending') {
                    applications = applications.filter(app => app.status === 'pending');
                } else if (filterType === 'approved') {
                    applications = applications.filter(app => app.status === 'approved');
                } else if (filterType === 'rejected') {
                    applications = applications.filter(app => app.status === 'rejected');
                }

                return applications;
            }

            // 通過申請
            approveApplication(applicationId) {
                const application = this.settings.staffApplications.find(app => app.id === applicationId);
                if (!application) {
                    return { success: false, message: '找不到申請記錄' };
                }

                // 更新申請狀態
                application.status = 'approved';
                application.decision = 'approved';
                application.reviewedAt = new Date().toISOString();
                application.reviewedBy = this.currentUser ? this.currentUser.username : 'system';
                application.reason = '審核通過';

                // 更新使用者角色
                const user = this.users.find(u => u.username === application.username);
                if (user) {
                    user.role = 'staff';
                } else {
                    this.users.push({
                        username: application.username,
                        realName: application.realName,
                        phoneNumber: application.phoneNumber,
                        role: 'staff'
                    });
                }

                return { 
                    success: true, 
                    message: `已通過 ${application.realName} 的老師/館員身份申請`,
                    application
                };
            }

            // 拒絕申請
            rejectApplication(applicationId) {
                const application = this.settings.staffApplications.find(app => app.id === applicationId);
                if (!application) {
                    return { success: false, message: '找不到申請記錄' };
                }

                // 更新申請狀態
                application.status = 'rejected';
                application.decision = 'rejected';
                application.reviewedAt = new Date().toISOString();
                application.reviewedBy = this.currentUser ? this.currentUser.username : 'system';
                application.reason = '審核拒絕';

                return { 
                    success: true, 
                    message: `已拒絕 ${application.realName} 的老師/館員身份申請`,
                    application
                };
            }

            // 搜尋申請
            searchApplications(searchTerm) {
                return this.settings.staffApplications.filter(application => 
                    application.realName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    application.username.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    application.phoneNumber.includes(searchTerm)
                );
            }

            // 同步到 Google Sheets
            async syncToGoogleSheets() {
                // 模擬同步過程
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({ 
                            success: true, 
                            message: '申請資料已成功同步到 Google Sheets',
                            syncedCount: this.settings.staffApplications.length
                        });
                    }, 1000);
                });
            }
        }

        const testLibrary = new TestLibrary();

        function addResult(title, content) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result';
            resultDiv.innerHTML = `
                <h3>${title}</h3>
                ${content}
            `;
            resultsDiv.appendChild(resultDiv);
        }

        function updateStatus() {
            const statusDiv = document.getElementById('current-status');
            const currentUser = testLibrary.currentUser;
            const applications = testLibrary.getApplications();
            const pendingApplications = testLibrary.getApplications('pending');
            
            statusDiv.innerHTML = `
                <div class="user-info">
                    <strong>當前使用者：</strong>${currentUser ? `${currentUser.realName} (${currentUser.username}) - ${currentUser.role}` : '未登入'}
                    ${currentUser && testLibrary.isAdminUser() ? '<span style="color: #28a745;"> [管理員]</span>' : ''}
                </div>
                <div class="application-item">
                    <strong>申請統計：</strong>共 ${applications.length} 筆申請，其中 ${pendingApplications.length} 筆待審核
                </div>
                <div class="application-item">
                    <strong>系統使用者數：</strong>${testLibrary.users.length} 位
                </div>
            `;
        }

        function testLogin() {
            const username = document.getElementById('test-username').value.trim();
            const realName = document.getElementById('test-realname').value.trim();
            const phoneNumber = document.getElementById('test-phone').value.trim();
            const role = document.getElementById('test-role').value;

            const result = testLibrary.login(username, realName, phoneNumber, role);
            
            addResult('模擬登入', `
                <div class="user-info">
                    <strong>結果：</strong>${result.success ? '成功' : '失敗'}<br>
                    <strong>訊息：</strong>${result.message}<br>
                    ${result.success ? `
                        <strong>使用者資訊：</strong><br>
                        • 帳號：${result.user.username}<br>
                        • 姓名：${result.user.realName}<br>
                        • 電話：${result.user.phoneNumber}<br>
                        • 角色：${result.user.role}<br>
                        ${result.applicationCreated ? '• 申請狀態：已創新申請' : ''}
                        ${result.applicationPending ? '• 申請狀態：待審核' : ''}
                        ${result.applicationApproved ? '• 申請狀態：已通過' : ''}
                    ` : ''}
                </div>
            `);
            
            testLibrary.currentUser = result.success ? result.user : null;
            updateStatus();
        }

        function testAdminLogin() {
            const result = testLibrary.login('sindy16872000', '系統管理員', '0912345678', 'staff');
            
            addResult('管理員登入', `
                <div class="user-info">
                    <strong>結果：</strong>${result.success ? '成功' : '失敗'}<br>
                    <strong>訊息：</strong>${result.message}<br>
                    ${result.success ? `
                        <strong>管理員權限：</strong>已啟用<br>
                        • 可以查看身分審核<br>
                        • 可以審核申請<br>
                        • 可以同步資料到 Google Sheets
                    ` : ''}
                </div>
            `);
            
            testLibrary.currentUser = result.success ? result.user : null;
            updateStatus();
        }

        function testLogout() {
            const result = testLibrary.logout();
            
            addResult('登出', `
                <div class="user-info">
                    <strong>結果：</strong>${result.success ? '成功' : '失敗'}<br>
                    <strong>訊息：</strong>${result.message}
                </div>
            `);
            
            updateStatus();
        }

        function createApplications() {
            const result = testLibrary.createSampleApplications();
            
            addResult('創建範例申請', result);
            updateStatus();
        }

        function showApplications() {
            const applications = testLibrary.getApplications();
            
            const applicationsHtml = applications.map(app => `
                <div class="application-item ${app.status}">
                    <strong>${app.realName}</strong> (${app.username})<br>
                    電話：${app.phoneNumber}<br>
                    申請時間：${new Date(app.submittedAt).toLocaleString()}<br>
                    狀態：<span class="status-badge ${app.status}">
                        ${app.status === 'pending' ? '待審核' : 
                          app.status === 'approved' ? '已通過' : '已拒絕'}
                    </span><br>
                    ${app.reviewedAt ? `
                        審核時間：${new Date(app.reviewedAt).toLocaleString()}<br>
                        審核人：${app.reviewedBy}<br>
                        審核意見：${app.reason}
                    ` : ''}
                </div>
            `).join('');

            addResult('所有申請記錄', applicationsHtml || '<p>沒有申請記錄</p>');
        }

        function showPendingApplications() {
            const pendingApplications = testLibrary.getApplications('pending');
            
            const pendingHtml = pendingApplications.map(app => `
                <div class="application-item pending">
                    <strong>${app.realName}</strong> (${app.username})<br>
                    電話：${app.phoneNumber}<br>
                    申請時間：${new Date(app.submittedAt).toLocaleString()}<br>
                    狀態：<span class="status-badge pending">待審核</span>
                </div>
            `).join('');

            addResult('待審核申請', pendingHtml || '<p>沒有待審核的申請</p>');
        }

        function testApprovalManagement() {
            if (!testLibrary.isAdminUser()) {
                addResult('身分審核管理', '<p style="color: #f56565;">請先以管理員身份登入</p>');
                return;
            }

            const applications = testLibrary.getApplications();
            const pendingCount = applications.filter(app => app.status === 'pending').length;
            
            addResult('身分審核管理', `
                <div class="user-info">
                    <strong>管理員功能：</strong>已啟用<br>
                    <strong>申請總數：</strong>${applications.length} 筆<br>
                    <strong>待審核數：</strong>${pendingCount} 筆<br>
                    <strong>已通過數：</strong>${applications.filter(app => app.status === 'approved').length} 筆<br>
                    <strong>已拒絕數：</strong>${applications.filter(app => app.status === 'rejected').length} 筆
                </div>
            `);
        }

        function testApproveApplication() {
            if (!testLibrary.isAdminUser()) {
                addResult('通過申請', '<p style="color: #f56565;">請先以管理員身份登入</p>');
                return;
            }

            const pendingApplications = testLibrary.getApplications('pending');
            if (pendingApplications.length === 0) {
                addResult('通過申請', '<p>沒有待審核的申請</p>');
                return;
            }

            const application = pendingApplications[0]; // 選擇第一個待審核申請
            const result = testLibrary.approveApplication(application.id);

            addResult('通過申請', `
                <div class="user-info">
                    <strong>結果：</strong>${result.success ? '成功' : '失敗'}<br>
                    <strong>訊息：</strong>${result.message}<br>
                    ${result.success ? `
                        <strong>審核詳情：</strong><br>
                        • 申請人：${result.application.realName}<br>
                        • 審核狀態：已通過<br>
                        • 審核時間：${new Date(result.application.reviewedAt).toLocaleString()}<br>
                        • 審核人：${result.application.reviewedBy}
                    ` : ''}
                </div>
            `);
            
            updateStatus();
        }

        function testRejectApplication() {
            if (!testLibrary.isAdminUser()) {
                addResult('拒絕申請', '<p style="color: #f56565;">請先以管理員身份登入</p>');
                return;
            }

            const pendingApplications = testLibrary.getApplications('pending');
            if (pendingApplications.length === 0) {
                addResult('拒絕申請', '<p>沒有待審核的申請</p>');
                return;
            }

            const application = pendingApplications[0]; // 選擇第一個待審核申請
            const result = testLibrary.rejectApplication(application.id);

            addResult('拒絕申請', `
                <div class="user-info">
                    <strong>結果：</strong>${result.success ? '成功' : '失敗'}<br>
                    <strong>訊息：</strong>${result.message}<br>
                    ${result.success ? `
                        <strong>審核詳情：</strong><br>
                        • 申請人：${result.application.realName}<br>
                        • 審核狀態：已拒絕<br>
                        • 審核時間：${new Date(result.application.reviewedAt).toLocaleString()}<br>
                        • 審核人：${result.application.reviewedBy}
                    ` : ''}
                </div>
            `);
            
            updateStatus();
        }

        function testSearchApplications() {
            if (!testLibrary.isAdminUser()) {
                addResult('搜尋申請', '<p style="color: #f56565;">請先以管理員身份登入</p>');
                return;
            }

            const searchTerm = prompt('請輸入搜尋關鍵字（姓名、帳號或電話）：');
            if (!searchTerm) return;

            const results = testLibrary.searchApplications(searchTerm);
            
            const resultsHtml = results.map(app => `
                <div class="application-item">
                    <strong>${app.realName}</strong> (${app.username})<br>
                    電話：${app.phoneNumber}<br>
                    狀態：<span class="status-badge ${app.status}">
                        ${app.status === 'pending' ? '待審核' : 
                          app.status === 'approved' ? '已通過' : '已拒絕'}
                    </span>
                </div>
            `).join('');

            addResult(`搜尋結果："${searchTerm}"`, resultsHtml || '<p>找不到符合的申請</p>');
        }

        function testGoogleSync() {
            if (!testLibrary.isAdminUser()) {
                addResult('Google Sheets 同步', '<p style="color: #f56565;">請先以管理員身份登入</p>');
                return;
            }

            addResult('Google Sheets 同步', '<p style="color: #17a2b8;">正在同步...</p>');
            
            testLibrary.syncToGoogleSheets().then(result => {
                const resultsDiv = document.getElementById('test-results');
                const lastResult = resultsDiv.lastElementChild;
                lastResult.innerHTML = `
                    <h3>Google Sheets 同步</h3>
                    <div class="user-info">
                        <strong>結果：</strong>${result.success ? '成功' : '失敗'}<br>
                        <strong>訊息：</strong>${result.message}<br>
                        ${result.success ? `
                            <strong>同步詳情：</strong><br>
                            • 同步筆數：${result.syncedCount} 筆<br>
                            • 同步時間：${new Date().toLocaleString()}
                        ` : ''}
                    </div>
                `;
            });
        }

        // 初始化
        window.onload = function() {
            addResult('系統初始化', '身分審核測試系統已準備就緒');
            updateStatus();
        };
    </script>
</body>
</html>
